<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™äº‹æ¥­ç®¡ç†ç³»çµ± - é¦¬å¡é¾é¢¨æ ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* é¦¬å¡é¾è‰²ç³»é…è‰² */
        :root {
            --macaron-pink: #FFD6E8;
            --macaron-lavender: #E8D5FF;
            --macaron-mint: #D5FFE8;
            --macaron-peach: #FFE5D5;
            --macaron-sky: #D5E8FF;
            --macaron-lemon: #FFFAD5;
            --macaron-coral: #FFB3B3;
            --macaron-sage: #B3D9B3;
            --text-primary: #5A5A5A;
            --text-secondary: #8A8A8A;
            --white: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--macaron-mint) 0%, var(--macaron-sky) 50%, var(--macaron-lavender) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--white);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-header {
            padding: 32px;
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            text-align: center;
        }

        .card-body {
            padding: 24px;
        }

        /* æ¨™é¡Œæ¨£å¼ */
        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            color: var(--text-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macaron-mint), var(--macaron-sage));
            color: var(--text-primary);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--macaron-sky), var(--macaron-mint));
            color: var(--text-primary);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--macaron-peach), var(--macaron-lemon));
            color: var(--text-primary);
        }

        .btn-coral {
            background: linear-gradient(135deg, var(--macaron-coral), var(--macaron-peach));
            color: var(--text-primary);
        }

        /* å°èˆªæŒ‰éˆ• */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .business-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .view-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 6px 24px var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--macaron-pink), var(--macaron-lavender));
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 8px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            background: var(--macaron-lemon);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macaron-lavender);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(232, 213, 255, 0.3);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-top: 20px;
        }

        .table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: var(--white);
        }

        .table th {
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border: none;
            font-size: 12px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--macaron-lemon);
            vertical-align: middle;
            font-size: 13px;
        }

        .table tr:hover {
            background: var(--macaron-lemon);
        }

        /* äº¤æ˜“é …ç›®æ¨£å¼ */
        .transaction-item {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 16px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid var(--macaron-mint);
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .transaction-item.income {
            border-left-color: var(--macaron-mint);
            background: linear-gradient(135deg, var(--white), var(--macaron-mint));
        }

        .transaction-item.expense {
            border-left-color: var(--macaron-coral);
            background: linear-gradient(135deg, var(--white), var(--macaron-peach));
        }

        .transaction-item.internal {
            border-left-color: var(--macaron-sky);
            background: linear-gradient(135deg, var(--white), var(--macaron-sky));
        }

        .transaction-item.external {
            border-left-color: var(--macaron-lavender);
            background: linear-gradient(135deg, var(--white), var(--macaron-lavender));
        }

        /* å…¥å¸³ç‹€æ…‹æ¨£å¼ */
        .accounting-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-recorded {
            background: var(--macaron-mint);
            color: var(--text-primary);
        }

        .status-pending {
            background: var(--macaron-peach);
            color: var(--text-primary);
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-income {
            background: var(--macaron-mint);
            color: var(--text-primary);
        }

        .tag-expense {
            background: var(--macaron-coral);
            color: var(--text-primary);
        }

        .tag-internal {
            background: var(--macaron-sky);
            color: var(--text-primary);
        }

        .tag-external {
            background: var(--macaron-lavender);
            color: var(--text-primary);
        }

        /* å°ç£é’å¹´å“ç‰Œæ¨™ç±¤ */
        .brand-taiwan-youth {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
        }

        /* å·¥å…·åˆ— */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        /* éš±è—/é¡¯ç¤ºå…ƒç´  */
        .hidden {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                grid-column: span 1;
            }
            
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .business-nav {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* è¡¨å–®å€åŸŸæ¨£å¼ */
        .form-section {
            background: linear-gradient(135deg, var(--macaron-lemon), var(--macaron-mint));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* é‡‘é¡é¡¯ç¤ºæ¨£å¼ */
        .amount-positive {
            color: #059669;
            font-weight: 700;
        }

        .amount-negative {
            color: #DC2626;
            font-weight: 700;
        }

        .amount-display {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* å¹´åº¦çµ±è¨ˆå®¹å™¨ */
        .yearly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        /* ç™¼ç¥¨åŠŸèƒ½æ¨£å¼ */
        .invoice-info {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .invoice-number {
            background: var(--macaron-sky);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            grid-column: span 2;
        }

        .btn-toggle {
            background: var(--macaron-mint);
            border: 2px solid var(--macaron-sage);
            color: var(--text-primary);
        }

        .btn-toggle.pending {
            background: var(--macaron-peach);
            border-color: var(--macaron-coral);
        }

        /* å¾½ç« æ¨£å¼ */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #DC2626;
            color: white;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 8px;
            min-width: 20px;
            text-align: center;
        }

        .badge.zero {
            background: var(--text-secondary);
        }

        /* å¾…å¯©æ ¸è¨˜éŒ„æ¨£å¼ */
        .pending-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 16px var(--shadow);
            border-left: 4px solid var(--macaron-peach);
        }

        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .pending-info {
            flex: 1;
        }

        .pending-actions {
            display: flex;
            gap: 8px;
        }

        .pending-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .pending-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .pending-detail {
            background: var(--macaron-lemon);
            padding: 12px;
            border-radius: 12px;
            margin-top: 12px;
        }

        .pending-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .pending-detail-row:last-child {
            border-bottom: none;
        }

        .pending-detail-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .pending-detail-value {
            color: var(--text-secondary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* åœ–è¡¨å®¹å™¨æ¨£å¼ */
        .chart-container {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 6px 24px var(--shadow);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--macaron-mint), var(--macaron-sky));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 6px 24px var(--shadow);
        }

        .summary-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .summary-item {
            background: var(--white);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-item-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .summary-item-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* éŸ¿æ‡‰å¼åœ–è¡¨ */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-wrapper {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»æ¨™é¡Œå¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h1 class="main-title">ğŸ¨ é›™äº‹æ¥­ç®¡ç†ç³»çµ±</h1>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="switchBusiness('studio')">
                        ğŸ“¸ æ”å½±å·¥ä½œå®¤
                    </button>
                    <button class="btn btn-success" onclick="switchBusiness('craft')">
                        ğŸ¨ æ‰‹å·¥è—å“äº‹æ¥­
                    </button>
                    <button class="btn btn-warning" onclick="showCustomerSubmissions()">
                        ğŸ“‹ å®¢æˆ¶è¡¨å–® <span id="customer-count" class="badge">0</span>
                    </button>
                    <button class="btn btn-coral" onclick="clearAllData()">
                        ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™
                    </button>
                </div>
            </div>
        </div>

        <!-- æ”å½±å·¥ä½œå®¤å€åŸŸ -->
        <div id="studio-section" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="business-nav">
                        <h2 class="section-title">ğŸ“¸ æ”å½±å·¥ä½œå®¤ç®¡ç†</h2>
                        <div class="view-nav">
                            <button class="btn btn-info" onclick="switchView('studio', 'dashboard')">ğŸ“Š è²¡å‹™æ¦‚æ³</button>
                            <button class="btn btn-warning" onclick="switchView('studio', 'internal')">ğŸ¢ å…§å¸³ç®¡ç†</button>
                            <button class="btn btn-primary" onclick="switchView('studio', 'external')">ğŸ’¼ å¤–å¸³ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('studio', 'monthly')">ğŸ“ˆ æœˆå ±è¡¨</button>
                            <button class="btn btn-success" onclick="switchView('studio', 'yearly')">ğŸ“… å¹´åº¦ç¸½è¡¨</button>
                            <button class="btn btn-coral" onclick="exportToExcel('studio')">ğŸ“„ åŒ¯å‡ºExcel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å„€è¡¨æ¿ -->
            <div id="studio-dashboard" class="fade-in">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå…§å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="studio-monthly-internal">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¶å…¥</div>
                        <div class="stat-value amount-positive" id="studio-monthly-external-income">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="studio-monthly-external-expense">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆæ·¨åˆ©</div>
                        <div class="stat-value" id="studio-monthly-profit">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¾…å…¥å¸³é‡‘é¡</div>
                        <div class="stat-value amount-negative" id="studio-pending-amount">NT$ 0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“ˆ æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h3>
                        <div id="studio-recent-transactions"></div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å…§å¸³ç®¡ç† -->
            <div id="studio-internal" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ¢ å…§å¸³ç®¡ç† (å·¥ä½œå®¤æ”¯å‡º)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('studio-internal-form')">
                                â• æ–°å¢å…§å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="studio-internal-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ”å½±å·¥ä½œå®¤å…§å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="studio-internal-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="studio-internal-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="studio-internal-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <input type="date" id="studio-internal-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="studio-internal-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="studio-internal-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="studio-internal-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('studio-internal')">
                                    <span id="studio-internal-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('studio', 'internal')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>é‡‘é¡</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="studio-internal-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å¤–å¸³ç®¡ç† -->
            <div id="studio-external" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ’¼ å¤–å¸³ç®¡ç† (ç‡Ÿæ¥­æ”¶æ”¯)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('studio-external-form')">
                                â• æ–°å¢å¤–å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="studio-external-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ”å½±å·¥ä½œå®¤å¤–å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="studio-external-type" class="form-control">
                                    <option value="income">ç‡Ÿæ¥­æ”¶å…¥</option>
                                    <option value="expense">ç‡Ÿæ¥­æ”¯å‡º</option>
                                </select>
                                <select id="studio-external-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="studio-external-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="studio-external-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <input type="date" id="studio-external-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="studio-external-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="studio-external-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="studio-external-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('studio-external')">
                                    <span id="studio-external-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('studio', 'external')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>é¡å‹</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>æ”¶å…¥</th>
                                        <th>æ”¯å‡º</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="studio-external-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤æœˆå ±è¡¨ -->
            <div id="studio-monthly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ“ˆ æ”å½±å·¥ä½œå®¤æœˆå ±è¡¨</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="month" id="studio-month-selector" class="form-control" style="width: auto;" onchange="updateMonthlyReport('studio')">
                                <button class="btn btn-coral" onclick="exportMonthlyToExcel('studio')">ğŸ“„ åŒ¯å‡ºæœˆå ±è¡¨</button>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦ç¸½æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="studio-report-total-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦ç¸½æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-report-total-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-report-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="studio-report-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-report-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦æ·¨åˆ©</div>
                                <div class="stat-value" id="studio-report-profit">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å·²å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value" id="studio-report-recorded">0 ç­†</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¾…å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value amount-negative" id="studio-report-pending">0 ç­†</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="section-title">ğŸ“‹ æœˆåº¦äº¤æ˜“æ˜ç´°</h4>
                                <div id="studio-monthly-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å¹´åº¦ç¸½è¡¨ -->
            <div id="studio-yearly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“… æ”å½±å·¥ä½œå®¤å¹´åº¦ç¸½è¡¨</h3>
                        
                        <!-- å¹´åº¦æ‘˜è¦å¡ç‰‡ -->
                        <div class="summary-card">
                            <div class="summary-title">ğŸ“Š å¹´åº¦è²¡å‹™æ‘˜è¦</div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-item-label">ç¸½ç‡Ÿæ”¶</div>
                                    <div class="summary-item-value amount-positive" id="studio-yearly-summary-income">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">ç¸½æ”¯å‡º</div>
                                    <div class="summary-item-value amount-negative" id="studio-yearly-summary-expense">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">æ·¨åˆ©æ½¤</div>
                                    <div class="summary-item-value" id="studio-yearly-summary-profit">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">æ·¨åˆ©ç‡</div>
                                    <div class="summary-item-value" id="studio-yearly-summary-margin">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- è©³ç´°çµ±è¨ˆå¡ç‰‡ -->
                        <div class="yearly-stats">
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç¸½æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="studio-yearly-total-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç¸½æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-yearly-total-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="studio-yearly-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-yearly-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="studio-yearly-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ·¨åˆ©</div>
                                <div class="stat-value" id="studio-yearly-profit">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å¾…å…¥å¸³</div>
                                <div class="stat-value amount-negative" id="studio-yearly-pending">NT$ 0</div>
                            </div>
                        </div>

                        <!-- åœ–è¡¨å€åŸŸ -->
                        <div class="charts-grid">
                            <div class="chart-container">
                                <div class="chart-title">ğŸ“ˆ æœˆåº¦æ”¶æ”¯è¶¨å‹¢</div>
                                <div class="chart-wrapper">
                                    <canvas id="studio-monthly-trend-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-title">ğŸ¥§ æ”¶æ”¯çµæ§‹åˆ†æ</div>
                                <div class="chart-wrapper">
                                    <canvas id="studio-expense-pie-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title">ğŸ“Š æœˆåº¦æ·¨åˆ©åˆ†æ</div>
                            <div class="chart-wrapper">
                                <canvas id="studio-profit-bar-chart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title">ğŸ’° æœƒè¨ˆç§‘ç›®æ”¯å‡ºåˆ†å¸ƒ (å…§å¸³)</div>
                            <div class="chart-wrapper">
                                <canvas id="studio-account-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰‹å·¥è—å“äº‹æ¥­å€åŸŸ -->
        <div id="craft-section" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="business-nav">
                        <h2 class="section-title">ğŸ¨ æ‰‹å·¥è—å“äº‹æ¥­ç®¡ç†</h2>
                        <div class="view-nav">
                            <button class="btn btn-info" onclick="switchView('craft', 'dashboard')">ğŸ“Š ç‡Ÿé‹æ¦‚æ³</button>
                            <button class="btn btn-warning" onclick="switchView('craft', 'internal')">ğŸ¢ å…§å¸³ç®¡ç†</button>
                            <button class="btn btn-primary" onclick="switchView('craft', 'external')">ğŸ’¼ å¤–å¸³ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'inventory')">ğŸ“¦ åº«å­˜ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'monthly')">ğŸ“ˆ æœˆå ±è¡¨</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'yearly')">ğŸ“… å¹´åº¦ç¸½è¡¨</button>
                            <button class="btn btn-coral" onclick="exportToExcel('craft')">ğŸ“„ åŒ¯å‡ºExcel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å„€è¡¨æ¿ -->
            <div id="craft-dashboard" class="fade-in">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå…§å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="craft-monthly-internal">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¶å…¥</div>
                        <div class="stat-value amount-positive" id="craft-monthly-external-income">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="craft-monthly-external-expense">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆæ·¨åˆ©</div>
                        <div class="stat-value" id="craft-monthly-profit">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åº«å­˜ç¸½å€¼</div>
                        <div class="stat-value" id="craft-inventory-value">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å°ç£é’å¹´å•†å“ç¸½å€¼</div>
                        <div class="stat-value" id="craft-taiwan-youth-value">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¾…å…¥å¸³é‡‘é¡</div>
                        <div class="stat-value amount-negative" id="craft-pending-amount">NT$ 0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ›ï¸ æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h3>
                        <div id="craft-recent-transactions"></div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å…§å¸³ç®¡ç† -->
            <div id="craft-internal" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ¢ å…§å¸³ç®¡ç† (å·¥ä½œå®¤æ”¯å‡º)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('craft-internal-form')">
                                â• æ–°å¢å…§å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="craft-internal-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ‰‹å·¥è—å“å…§å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="craft-internal-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="craft-internal-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="craft-internal-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <input type="date" id="craft-internal-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="craft-internal-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="craft-internal-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="craft-internal-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('craft-internal')">
                                    <span id="craft-internal-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('craft', 'internal')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>é‡‘é¡</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="craft-internal-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å¤–å¸³ç®¡ç† -->
            <div id="craft-external" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ’¼ å¤–å¸³ç®¡ç† (ç‡Ÿæ¥­æ”¶æ”¯)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('craft-external-form')">
                                â• æ–°å¢å¤–å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="craft-external-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ‰‹å·¥è—å“å¤–å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="craft-external-type" class="form-control" onchange="handleExternalTypeChange()">
                                    <option value="income">ç‡Ÿæ¥­æ”¶å…¥</option>
                                    <option value="expense">ç‡Ÿæ¥­æ”¯å‡º</option>
                                </select>
                                <select id="craft-external-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="craft-external-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="craft-external-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <select id="craft-external-brand" class="form-control">
                                    <option value="">é¸æ“‡å“ç‰Œ</option>
                                    <option value="å°ç£é’å¹´">å°ç£é’å¹´</option>
                                    <option value="å…¶ä»–">å…¶ä»–å“ç‰Œ</option>
                                </select>
                                
                                <!-- å•†å“é¸æ“‡å€åŸŸ -->
                                <div id="craft-product-selection" class="hidden" style="grid-column: 1 / -1;">
                                    <h5 style="margin-bottom: 12px; color: var(--text-primary);">å•†å“éŠ·å”®è©³æƒ…</h5>
                                    <div class="form-grid">
                                        <select id="craft-external-product" class="form-control" onchange="updateProductInfo()">
                                            <option value="">é¸æ“‡å•†å“</option>
                                        </select>
                                        <input type="number" id="craft-external-sale-quantity" class="form-control" placeholder="éŠ·å”®æ•¸é‡" min="1" onchange="calculateSaleAmount()">
                                    </div>
                                    <div id="craft-selected-product-info" style="margin-top: 12px; padding: 12px; background: var(--macaron-lemon); border-radius: 12px; font-size: 13px;"></div>
                                </div>
                                
                                <input type="date" id="craft-external-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="craft-external-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="craft-external-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="craft-external-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('craft-external')">
                                    <span id="craft-external-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('craft', 'external')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>é¡å‹</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>å•†å“è³‡è¨Š</th>
                                        <th>å“ç‰Œ</th>
                                        <th>æ”¶å…¥</th>
                                        <th>æ”¯å‡º</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="craft-external-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº«å­˜ç®¡ç† -->
            <div id="craft-inventory" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ“¦ åº«å­˜ç®¡ç†</h3>
                            <button class="btn btn-primary" onclick="toggleForm('inventory-form')">
                                â• æ–°å¢å•†å“
                            </button>
                        </div>

                        <div id="inventory-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢åº«å­˜å•†å“</h4>
                            <div class="form-grid">
                                <select id="inventory-category" class="form-control">
                                    <option value="">é¸æ“‡å•†å“é¡åˆ¥</option>
                                    <option value="ä¸Šè¡£">ä¸Šè¡£</option>
                                    <option value="ä¸‹è‘—">ä¸‹è‘—</option>
                                    <option value="å¤–å¥—">å¤–å¥—</option>
                                    <option value="é€£èº«è£™">é€£èº«è£™</option>
                                    <option value="é…ä»¶">é…ä»¶</option>
                                    <option value="é£¾å“">é£¾å“</option>
                                    <option value="åŒ…åŒ…">åŒ…åŒ…</option>
                                    <option value="é‹é¡">é‹é¡</option>
                                    <option value="å®¶å±…ç”¨å“">å®¶å±…ç”¨å“</option>
                                    <option value="æ–‡å…·ç”¨å“">æ–‡å…·ç”¨å“</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                                <input type="text" id="inventory-name" class="form-control" placeholder="å•†å“åç¨±">
                                <input type="number" id="inventory-cost" class="form-control" placeholder="æˆæœ¬">
                                <input type="number" id="inventory-price" class="form-control" placeholder="å”®åƒ¹">
                                <input type="number" id="inventory-quantity" class="form-control" placeholder="æ•¸é‡">
                                
                                <!-- é¡è‰²é¸æ“‡ -->
                                <select id="inventory-color" class="form-control">
                                    <option value="">é¸æ“‡é¡è‰² (é¸å¡«)</option>
                                    <option value="é»‘è‰²">é»‘è‰²</option>
                                    <option value="ç™½è‰²">ç™½è‰²</option>
                                    <option value="ç°è‰²">ç°è‰²</option>
                                    <option value="ç´…è‰²">ç´…è‰²</option>
                                    <option value="è—è‰²">è—è‰²</option>
                                    <option value="ç¶ è‰²">ç¶ è‰²</option>
                                    <option value="é»ƒè‰²">é»ƒè‰²</option>
                                    <option value="ç´«è‰²">ç´«è‰²</option>
                                    <option value="ç²‰è‰²">ç²‰è‰²</option>
                                    <option value="æ©™è‰²">æ©™è‰²</option>
                                    <option value="å’–å•¡è‰²">å’–å•¡è‰²</option>
                                    <option value="ç±³è‰²">ç±³è‰²</option>
                                    <option value="æµ·è»è—">æµ·è»è—</option>
                                    <option value="å¡å…¶è‰²">å¡å…¶è‰²</option>
                                    <option value="å¤šè‰²">å¤šè‰²</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                                
                                <!-- å°ºå¯¸é¸æ“‡ -->
                                <select id="inventory-size" class="form-control">
                                    <option value="">é¸æ“‡å°ºå¯¸ (é¸å¡«)</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="Free Size">Free Size</option>
                                    <option value="25">25</option>
                                    <option value="26">26</option>
                                    <option value="27">27</option>
                                    <option value="28">28</option>
                                    <option value="29">29</option>
                                    <option value="30">30</option>
                                    <option value="31">31</option>
                                    <option value="32">32</option>
                                    <option value="å°">å°</option>
                                    <option value="ä¸­">ä¸­</option>
                                    <option value="å¤§">å¤§</option>
                                    <option value="å…¶ä»–">å…¶ä»–</option>
                                </select>
                                <select id="inventory-brand" class="form-control">
                                    <option value="">é¸æ“‡å“ç‰Œ</option>
                                    <option value="å°ç£é’å¹´">å°ç£é’å¹´</option>
                                    <option value="å…¶ä»–">å…¶ä»–å“ç‰Œ</option>
                                </select>
                                <input type="text" id="inventory-notes" class="form-control" placeholder="å‚™è¨»">
                                <button class="btn btn-success" onclick="addInventoryItem()">æ–°å¢å•†å“</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>å“ç‰Œ</th>
                                        <th>åˆ†é¡</th>
                                        <th>å•†å“åç¨±</th>
                                        <th>é¡è‰²</th>
                                        <th>å°ºå¯¸</th>
                                        <th>æˆæœ¬</th>
                                        <th>å”®åƒ¹</th>
                                        <th>åº«å­˜é‡</th>
                                        <th>åº«å­˜åƒ¹å€¼</th>
                                        <th>å‚™è¨»</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="craft-inventory-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“æœˆå ±è¡¨ -->
            <div id="craft-monthly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ“ˆ æ‰‹å·¥è—å“äº‹æ¥­æœˆå ±è¡¨</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="month" id="craft-month-selector" class="form-control" style="width: auto;" onchange="updateMonthlyReport('craft')">
                                <button class="btn btn-coral" onclick="exportMonthlyToExcel('craft')">ğŸ“„ åŒ¯å‡ºæœˆå ±è¡¨</button>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦ç¸½æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-report-total-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦ç¸½æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-report-total-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-report-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-report-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-report-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦æ·¨åˆ©</div>
                                <div class="stat-value" id="craft-report-profit">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å°ç£é’å¹´éŠ·å”®</div>
                                <div class="stat-value" id="craft-report-taiwan-youth">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å·²å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value" id="craft-report-recorded">0 ç­†</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¾…å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value amount-negative" id="craft-report-pending">0 ç­†</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="section-title">ğŸ“‹ æœˆåº¦äº¤æ˜“æ˜ç´°</h4>
                                <div id="craft-monthly-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å¹´åº¦ç¸½è¡¨ -->
            <div id="craft-yearly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“… æ‰‹å·¥è—å“äº‹æ¥­å¹´åº¦ç¸½è¡¨</h3>
                        
                        <!-- å¹´åº¦æ‘˜è¦å¡ç‰‡ -->
                        <div class="summary-card">
                            <div class="summary-title">ğŸ“Š å¹´åº¦è²¡å‹™æ‘˜è¦</div>
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-item-label">ç¸½ç‡Ÿæ”¶</div>
                                    <div class="summary-item-value amount-positive" id="craft-yearly-summary-income">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">ç¸½æ”¯å‡º</div>
                                    <div class="summary-item-value amount-negative" id="craft-yearly-summary-expense">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">æ·¨åˆ©æ½¤</div>
                                    <div class="summary-item-value" id="craft-yearly-summary-profit">NT$ 0</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">æ·¨åˆ©ç‡</div>
                                    <div class="summary-item-value" id="craft-yearly-summary-margin">0%</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-item-label">å°ç£é’å¹´ä½”æ¯”</div>
                                    <div class="summary-item-value" id="craft-yearly-summary-taiwan-youth-ratio">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- è©³ç´°çµ±è¨ˆå¡ç‰‡ -->
                        <div class="yearly-stats">
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç¸½æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-yearly-total-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç¸½æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-yearly-total-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-yearly-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-yearly-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-yearly-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ·¨åˆ©</div>
                                <div class="stat-value" id="craft-yearly-profit">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å°ç£é’å¹´éŠ·å”®é¡</div>
                                <div class="stat-value" id="craft-taiwan-youth-sales">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å¾…å…¥å¸³</div>
                                <div class="stat-value amount-negative" id="craft-yearly-pending">NT$ 0</div>
                            </div>
                        </div>

                        <!-- åœ–è¡¨å€åŸŸ -->
                        <div class="charts-grid">
                            <div class="chart-container">
                                <div class="chart-title">ğŸ“ˆ æœˆåº¦æ”¶æ”¯è¶¨å‹¢</div>
                                <div class="chart-wrapper">
                                    <canvas id="craft-monthly-trend-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-title">ğŸ¥§ æ”¶æ”¯çµæ§‹åˆ†æ</div>
                                <div class="chart-wrapper">
                                    <canvas id="craft-expense-pie-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="charts-grid">
                            <div class="chart-container">
                                <div class="chart-title">ğŸ“Š æœˆåº¦æ·¨åˆ©åˆ†æ</div>
                                <div class="chart-wrapper">
                                    <canvas id="craft-profit-bar-chart"></canvas>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-title">ğŸ¨ å°ç£é’å¹´å“ç‰ŒéŠ·å”®è¶¨å‹¢</div>
                                <div class="chart-wrapper">
                                    <canvas id="craft-taiwan-youth-trend-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title">ğŸ’° å•†å“é¡åˆ¥éŠ·å”®åˆ†å¸ƒ</div>
                            <div class="chart-wrapper">
                                <canvas id="craft-category-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®¢æˆ¶è¡¨å–®ç®¡ç†å€åŸŸ -->
        <div id="customer-section" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="business-nav">
                        <h2 class="section-title">ğŸ“‹ å®¢æˆ¶è¡¨å–®ç®¡ç†</h2>
                        <button class="btn btn-coral" onclick="closeCustomerSubmissions()">
                            âœ– é—œé–‰
                        </button>
                    </div>
                    
                    <div id="customer-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™å„²å­˜çµæ§‹
        let businessData = {
            studio: {
                internal: [],
                external: []
            },
            craft: {
                internal: [],
                external: [],
                inventory: []
            }
        };

        // æœƒè¨ˆç§‘ç›®è¨­å®š
        const accounts = {
            studio: {
                internal: [
                    'ç§Ÿé‡‘æ”¯å‡º', 'æ°´é›»è²»ç”¨', 'ç¶²è·¯è²»ç”¨', 'æ¸…æ½”è²»ç”¨', 'è¨­å‚™ç¶­è­·è²»', 
                    'å…¬å…±è¨­æ–½ä½¿ç”¨è²»', 'ç®¡ç†è²»ç”¨', 'ä¿éšªè²»ç”¨', 'å…¶ä»–å…±åŒæ”¯å‡º'
                ],
                external: {
                    income: [
                        'æ”å½±æœå‹™æ”¶å…¥', 'å©šç¦®æ”å½±æ”¶å…¥', 'å•†æ¥­æ”å½±æ”¶å…¥', 'äººåƒæ”å½±æ”¶å…¥', 
                        'æ´»å‹•æ”å½±æ”¶å…¥', 'å½±ç‰‡è£½ä½œæ”¶å…¥', 'å¾Œè£½æœå‹™æ”¶å…¥', 'å™¨æç§Ÿå€Ÿæ”¶å…¥', 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                    ],
                    expense: [
                        'è¨­å‚™è²»ç”¨', 'å™¨ææŠ˜èˆŠ', 'ç¶­ä¿®è²»ç”¨', 'äº¤é€šè²»ç”¨', 'è¡ŒéŠ·è²»ç”¨', 
                        'è¾¦å…¬è²»ç”¨', 'è»Ÿé«”æˆæ¬Šè²»', 'éŠ€è¡Œæ‰‹çºŒè²»', 'ç¨…å‹™è²»ç”¨', 'å…¶ä»–ç‡Ÿæ¥­è²»ç”¨'
                    ]
                }
            },
            craft: {
                internal: [
                    'ç§Ÿé‡‘æ”¯å‡º', 'æ°´é›»è²»ç”¨', 'ç¶²è·¯è²»ç”¨', 'å·¥å…·è¨­å‚™è²»', 'ç¶­ä¿®ä¿é¤Šè²»',
                    'ä¿éšªè²»ç”¨', 'å…¶ä»–å·¥ä½œå®¤è²»ç”¨'
                ],
                external: {
                    income: [
                        'ä¸Šè¡£éŠ·å”®æ”¶å…¥', 'ä¸‹è‘—éŠ·å”®æ”¶å…¥', 'å¤–å¥—éŠ·å”®æ”¶å…¥', 'é€£èº«è£™éŠ·å”®æ”¶å…¥',
                        'é…ä»¶éŠ·å”®æ”¶å…¥', 'é£¾å“éŠ·å”®æ”¶å…¥', 'åŒ…åŒ…éŠ·å”®æ”¶å…¥', 'é‹é¡éŠ·å”®æ”¶å…¥',
                        'å®¶å±…ç”¨å“éŠ·å”®æ”¶å…¥', 'æ–‡å…·ç”¨å“éŠ·å”®æ”¶å…¥', 'å®¢è£½åŒ–æ”¶å…¥', 'æ•™å­¸æ”¶å…¥', 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                    ],
                    expense: [
                        'åŸæ–™æˆæœ¬', 'åŒ…è£ææ–™è²»', 'é‹è²»æ”¯å‡º', 'è¡ŒéŠ·è²»ç”¨', 
                        'å¸‚å ´æ”¤ä½è²»', 'ç¶²è·¯å¹³å°è²»ç”¨', 'éŠ€è¡Œæ‰‹çºŒè²»', 'å…¶ä»–ç‡Ÿæ¥­è²»ç”¨'
                    ]
                }
            }
        };

        // ç•¶å‰ç‹€æ…‹
        let currentBusiness = '';
        let currentView = '';
        let currentAccountingStatus = { 
            'studio-internal': 'recorded', 
            'studio-external': 'recorded', 
            'craft-internal': 'recorded', 
            'craft-external': 'recorded' 
        };

        // åœ–è¡¨å¯¦ä¾‹å„²å­˜
        let chartInstances = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // è¨­å®šä»Šæ—¥æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = [
                'studio-internal-date', 'studio-external-date',
                'craft-internal-date', 'craft-external-date'
            ];
            
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = today;
            });
            
            // åˆå§‹åŒ–æœƒè¨ˆç§‘ç›®é¸é …
            updateAccountOptions();
            
            // åˆå§‹åŒ–å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
            initializeAccountingStatusButtons();
            
            // æ›´æ–°å®¢æˆ¶è¡¨å–®æ•¸é‡
            updateCustomerCount();
            
            // é¡¯ç¤ºæ”å½±å·¥ä½œå®¤
            switchBusiness('studio');
        });

        // åˆå§‹åŒ–å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
        function initializeAccountingStatusButtons() {
            const formTypes = ['studio-internal', 'studio-external', 'craft-internal', 'craft-external'];
            formTypes.forEach(type => {
                const toggleBtn = document.getElementById(type + '-status-toggle');
                const textSpan = document.getElementById(type + '-status-text');
                if (toggleBtn && textSpan) {
                    toggleBtn.classList.remove('pending');
                    textSpan.textContent = 'å·²å…¥å¸³';
                    currentAccountingStatus[type] = 'recorded';
                }
            });
        }

        // åˆ‡æ›å…¥å¸³ç‹€æ…‹
        function toggleAccountingStatus(formType) {
            const toggleBtn = document.getElementById(formType + '-status-toggle');
            const textSpan = document.getElementById(formType + '-status-text');
            
            if (!toggleBtn || !textSpan) return;
            
            // åˆ‡æ›ç‹€æ…‹
            if (currentAccountingStatus[formType] === 'recorded') {
                currentAccountingStatus[formType] = 'pending';
                toggleBtn.classList.add('pending');
                textSpan.textContent = 'å¾…å…¥å¸³';
            } else {
                currentAccountingStatus[formType] = 'recorded';
                toggleBtn.classList.remove('pending');
                textSpan.textContent = 'å·²å…¥å¸³';
            }
        }

        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const savedData = localStorage.getItem('businessData');
            if (savedData) {
                businessData = JSON.parse(savedData);
                
                // ç¢ºä¿èˆŠè³‡æ–™æœ‰æ–°æ¬„ä½
                ['studio', 'craft'].forEach(business => {
                    ['internal', 'external'].forEach(category => {
                        if (businessData[business][category]) {
                            businessData[business][category].forEach(item => {
                                if (!item.hasOwnProperty('invoiceNumber')) item.invoiceNumber = '';
                                if (!item.hasOwnProperty('invoiceDate')) item.invoiceDate = '';
                                if (!item.hasOwnProperty('accountingStatus')) item.accountingStatus = 'recorded';
                            });
                        }
                    });
                });
                
                // ç¢ºä¿åº«å­˜è³‡æ–™æœ‰æ–°æ¬„ä½
                if (businessData.craft.inventory) {
                    businessData.craft.inventory.forEach(item => {
                        if (!item.hasOwnProperty('color')) item.color = '';
                        if (!item.hasOwnProperty('size')) item.size = '';
                    });
                }
            }
            saveData();
        }

        // å„²å­˜è³‡æ–™
        function saveData() {
            localStorage.setItem('businessData', JSON.stringify(businessData));
        }

        // æ›´æ–°æœƒè¨ˆç§‘ç›®é¸é …
        function updateAccountOptions() {
            // æ”å½±å·¥ä½œå®¤å…§å¸³
            updateSelectOptions('studio-internal-account', accounts.studio.internal);
            
            // æ”å½±å·¥ä½œå®¤å¤–å¸³
            const studioExternalType = document.getElementById('studio-external-type');
            if (studioExternalType) {
                studioExternalType.addEventListener('change', function() {
                    updateSelectOptions('studio-external-account', accounts.studio.external[this.value]);
                });
            }
            updateSelectOptions('studio-external-account', accounts.studio.external.income);

            // æ‰‹å·¥è—å“å…§å¸³
            updateSelectOptions('craft-internal-account', accounts.craft.internal);
            
            // æ‰‹å·¥è—å“å¤–å¸³
            const craftExternalType = document.getElementById('craft-external-type');
            if (craftExternalType) {
                craftExternalType.addEventListener('change', function() {
                    updateSelectOptions('craft-external-account', accounts.craft.external[this.value]);
                });
            }
            updateSelectOptions('craft-external-account', accounts.craft.external.income);
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>';
            options.forEach(option => {
                select.innerHTML += `<option value="${option}">${option}</option>`;
            });
        }

        // è™•ç†å¤–å¸³é¡å‹è®Šæ›´
        function handleExternalTypeChange() {
            const type = document.getElementById('craft-external-type').value;
            updateSelectOptions('craft-external-account', accounts.craft.external[type]);
            toggleProductSelection(type === 'income');
        }

        // åˆ‡æ›äº‹æ¥­
        function switchBusiness(business) {
            currentBusiness = business;
            
            // éš±è—æ‰€æœ‰å€åŸŸ
            document.getElementById('studio-section').classList.add('hidden');
            document.getElementById('craft-section').classList.add('hidden');
            
            // é¡¯ç¤ºé¸æ“‡çš„å€åŸŸ
            document.getElementById(business + '-section').classList.remove('hidden');
            
            // é¡¯ç¤ºå„€è¡¨æ¿
            switchView(business, 'dashboard');
        }

        // åˆ‡æ›è¦–åœ–
        function switchView(business, view) {
            currentView = view;
            
            // éš±è—æ‰€æœ‰è¦–åœ–
            const viewIds = {
                studio: ['dashboard', 'internal', 'external', 'monthly', 'yearly'],
                craft: ['dashboard', 'internal', 'external', 'inventory', 'monthly', 'yearly']
            };
            
            viewIds[business].forEach(viewId => {
                const element = document.getElementById(business + '-' + viewId);
                if (element) element.classList.add('hidden');
            });
            
            // é¡¯ç¤ºé¸æ“‡çš„è¦–åœ–
            const targetView = document.getElementById(business + '-' + view);
            if (targetView) targetView.classList.remove('hidden');
            
            // æ›´æ–°è³‡æ–™
            updateView(business, view);
        }

        // æ›´æ–°è¦–åœ–è³‡æ–™
        function updateView(business, view) {
            switch (view) {
                case 'dashboard':
                    updateDashboard(business);
                    break;
                case 'internal':
                    updateInternalTable(business);
                    break;
                case 'external':
                    updateExternalTable(business);
                    break;
                case 'inventory':
                    updateInventoryTable();
                    updateProductSelection();
                    break;
                case 'monthly':
                    initializeMonthSelector(business);
                    updateMonthlyReport(business);
                    break;
                case 'yearly':
                    updateYearlyStats(business);
                    break;
            }
        }

        // åˆ‡æ›è¡¨å–®é¡¯ç¤º
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.classList.toggle('hidden');
        }

        // åˆ‡æ›å•†å“é¸æ“‡å€åŸŸé¡¯ç¤º
        function toggleProductSelection(showProducts) {
            const productSection = document.getElementById('craft-product-selection');
            if (productSection) {
                if (showProducts) {
                    productSection.classList.remove('hidden');
                    updateProductSelection();
                } else {
                    productSection.classList.add('hidden');
                }
            }
        }

        // æ›´æ–°å•†å“é¸æ“‡é¸é …
        function updateProductSelection() {
            const productSelect = document.getElementById('craft-external-product');
            if (!productSelect) return;
            
            productSelect.innerHTML = '<option value="">é¸æ“‡å•†å“</option>';
            
            businessData.craft.inventory
                .filter(item => item.quantity > 0)
                .forEach(item => {
                    const displayName = `${item.name} ${item.color ? `(${item.color}` : ''}${item.size ? ` ${item.size}` : ''}${item.color || item.size ? ')' : ''} - åº«å­˜:${item.quantity}`;
                    productSelect.innerHTML += `<option value="${item.id}">${displayName}</option>`;
                });
        }

        // æ›´æ–°é¸ä¸­å•†å“è³‡è¨Š
        function updateProductInfo() {
            const productId = document.getElementById('craft-external-product').value;
            const infoDiv = document.getElementById('craft-selected-product-info');
            const quantityInput = document.getElementById('craft-external-sale-quantity');
            
            if (!productId || !infoDiv) {
                if (infoDiv) infoDiv.innerHTML = '';
                return;
            }
            
            const product = businessData.craft.inventory.find(item => item.id == productId);
            if (!product) return;
            
            const brandTag = product.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : (product.brand || '');
            const colorTag = product.color ? `<span style="padding: 2px 6px; background: var(--macaron-sky); border-radius: 8px; font-size: 11px;">${product.color}</span>` : '';
            const sizeTag = product.size ? `<span style="padding: 2px 6px; background: var(--macaron-peach); border-radius: 8px; font-size: 11px;">${product.size}</span>` : '';
            
            infoDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <strong>${product.name}</strong>
                    <div style="display: flex; gap: 4px;">${brandTag} ${colorTag} ${sizeTag}</div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px;">
                    <span>é¡åˆ¥: ${product.category}</span>
                    <span>åº«å­˜: ${product.quantity} ä»¶</span>
                    <span>å”®åƒ¹: NT$ ${product.price.toLocaleString()}</span>
                </div>
            `;
        }

        // è¨ˆç®—éŠ·å”®é‡‘é¡
        function calculateSaleAmount() {
            const productId = document.getElementById('craft-external-product').value;
            const quantity = parseInt(document.getElementById('craft-external-sale-quantity').value) || 0;
            const amountInput = document.getElementById('craft-external-amount');
            
            if (!productId || quantity <= 0) return;
            
            const product = businessData.craft.inventory.find(item => item.id == productId);
            if (!product) return;
            
            if (quantity > product.quantity) {
                alert('éŠ·å”®æ•¸é‡ä¸èƒ½è¶…éåº«å­˜æ•¸é‡!');
                document.getElementById('craft-external-sale-quantity').value = product.quantity;
                return;
            }
            
            amountInput.value = quantity * product.price;
        }

        // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
        function initializeMonthSelector(business) {
            const selector = document.getElementById(business + '-month-selector');
            if (!selector) return;
            
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            selector.value = currentMonth;
        }

        // æ›´æ–°æœˆå ±è¡¨
        function updateMonthlyReport(business) {
            const selector = document.getElementById(business + '-month-selector');
            if (!selector || !selector.value) return;
            
            const [year, month] = selector.value.split('-').map(Number);
            
            // ç¯©é¸è©²æœˆä»½çš„äº¤æ˜“è³‡æ–™
            const monthlyInternal = businessData[business].internal.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            const monthlyExternal = businessData[business].external.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const internalAmount = monthlyInternal.reduce((sum, t) => sum + t.amount, 0);
            const incomeAmount = monthlyExternal.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenseAmount = monthlyExternal.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const profit = incomeAmount - expenseAmount - internalAmount;
            
            // è¨ˆç®—ç¸½æ”¶å…¥ç¸½æ”¯å‡º
            const totalIncome = incomeAmount;
            const totalExpense = internalAmount + expenseAmount;
            
            // è¨ˆç®—å…¥å¸³ç‹€æ…‹çµ±è¨ˆ
            const allTransactions = [...monthlyInternal, ...monthlyExternal];
            const recordedCount = allTransactions.filter(t => t.accountingStatus === 'recorded').length;
            const pendingCount = allTransactions.filter(t => t.accountingStatus === 'pending').length;
            
            // æ›´æ–°é¡¯ç¤º
            const elements = {
                [`${business}-report-total-income`]: `NT$ ${totalIncome.toLocaleString()}`,
                [`${business}-report-total-expense`]: `NT$ ${totalExpense.toLocaleString()}`,
                [`${business}-report-internal`]: `NT$ ${internalAmount.toLocaleString()}`,
                [`${business}-report-income`]: `NT$ ${incomeAmount.toLocaleString()}`,
                [`${business}-report-expense`]: `NT$ ${expenseAmount.toLocaleString()}`,
                [`${business}-report-profit`]: `NT$ ${profit.toLocaleString()}`,
                [`${business}-report-recorded`]: `${recordedCount} ç­†`,
                [`${business}-report-pending`]: `${pendingCount} ç­†`
            };
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const taiwanYouthSales = monthlyExternal
                    .filter(t => t.type === 'income' && t.brand === 'å°ç£é’å¹´')
                    .reduce((sum, t) => sum + t.amount, 0);
                elements[`${business}-report-taiwan-youth`] = `NT$ ${taiwanYouthSales.toLocaleString()}`;
            }
            
            Object.entries(elements).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                    if (id.includes('profit')) {
                        element.className = `stat-value ${profit >= 0 ? 'amount-positive' : 'amount-negative'}`;
                    }
                }
            });
            
            // æ›´æ–°äº¤æ˜“æ˜ç´°
            updateMonthlyDetails(business, monthlyInternal, monthlyExternal);
        }

        // æ›´æ–°æœˆåº¦äº¤æ˜“æ˜ç´°
        function updateMonthlyDetails(business, monthlyInternal, monthlyExternal) {
            const container = document.getElementById(business + '-monthly-details');
            if (!container) return;
            
            // åˆä½µä¸¦æ’åºæ‰€æœ‰äº¤æ˜“
            const allTransactions = [
                ...monthlyInternal.map(t => ({...t, category: 'internal'})),
                ...monthlyExternal.map(t => ({...t, category: 'external'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">æœ¬æœˆæš«ç„¡äº¤æ˜“è¨˜éŒ„</p>';
                return;
            }
            
            container.innerHTML = allTransactions.map(t => {
                let typeClass = '';
                let typeLabel = '';
                let amountPrefix = '';
                
                if (t.category === 'internal') {
                    typeClass = 'internal';
                    typeLabel = 'å…§å¸³';
                    amountPrefix = '-';
                } else if (t.type === 'income') {
                    typeClass = 'income';
                    typeLabel = 'å¤–å¸³æ”¶å…¥';
                    amountPrefix = '+';
                } else {
                    typeClass = 'expense';
                    typeLabel = 'å¤–å¸³æ”¯å‡º';
                    amountPrefix = '-';
                }
                
                const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : '';
                const invoiceInfo = t.invoiceNumber ? `<span class="invoice-number">${t.invoiceNumber}</span>` : '';
                const statusButton = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', '${t.category}', ${t.id})" style="padding: 2px 6px; font-size: 10px; margin-left: 4px;">
                    ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                </button>`;
                
                return `
                    <div class="transaction-item ${typeClass}">
                        <div>
                            <div class="amount-display">${t.description}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">
                                <span class="tag tag-${typeClass}">${typeLabel}</span>
                                ${t.account} â€¢ ${t.date}
                                ${brandTag}
                                ${invoiceInfo}
                                ${statusButton}
                            </div>
                        </div>
                        <div class="amount-display ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amountPrefix}NT$ ${t.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŒ¯å‡ºæœˆå ±è¡¨Excel
        function exportMonthlyToExcel(business) {
            if (typeof XLSX === 'undefined') {
                alert('ExcelåŠŸèƒ½è¼‰å…¥ä¸­,è«‹ç¨å¾Œå†è©¦...');
                return;
            }
            
            const selector = document.getElementById(business + '-month-selector');
            if (!selector || !selector.value) {
                alert('è«‹é¸æ“‡è¦åŒ¯å‡ºçš„æœˆä»½');
                return;
            }
            
            const [year, month] = selector.value.split('-').map(Number);
            const monthName = `${year}å¹´${month}æœˆ`;
            
            // ç¯©é¸è©²æœˆä»½çš„è³‡æ–™
            const monthlyInternal = businessData[business].internal.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            const monthlyExternal = businessData[business].external.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            const wb = XLSX.utils.book_new();
            
            // æœˆåº¦å…§å¸³å ±è¡¨
            if (monthlyInternal.length > 0) {
                const internalData = monthlyInternal.map(t => ({
                    'äº¤æ˜“æ—¥æœŸ': t.date,
                    'æœƒè¨ˆç§‘ç›®': t.account,
                    'æ‘˜è¦èªªæ˜': t.description,
                    'é‡‘é¡': t.amount,
                    'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                    'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                    'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(internalData);
                XLSX.utils.book_append_sheet(wb, ws1, `${monthName}å…§å¸³`);
            }
            
            // æœˆåº¦å¤–å¸³å ±è¡¨
            if (monthlyExternal.length > 0) {
                const externalData = monthlyExternal.map(t => {
                    const data = {
                        'äº¤æ˜“æ—¥æœŸ': t.date,
                        'æœƒè¨ˆç§‘ç›®': t.account,
                        'æ‘˜è¦èªªæ˜': t.description,
                        'æ”¶å…¥': t.type === 'income' ? t.amount : '',
                        'æ”¯å‡º': t.type === 'expense' ? t.amount : '',
                        'é¡å‹': t.type === 'income' ? 'ç‡Ÿæ¥­æ”¶å…¥' : 'ç‡Ÿæ¥­æ”¯å‡º',
                        'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                        'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                        'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                    };
                    
                    if (business === 'craft') {
                        data['å“ç‰Œ'] = t.brand || '';
                        if (t.productInfo) {
                            data['å•†å“åç¨±'] = t.productInfo.productName;
                            data['å•†å“é¡åˆ¥'] = t.productInfo.productCategory;
                            data['é¡è‰²'] = t.productInfo.productColor || '';
                            data['å°ºå¯¸'] = t.productInfo.productSize || '';
                            data['éŠ·å”®æ•¸é‡'] = t.productInfo.saleQuantity;
                        }
                    }
                    
                    return data;
                });
                
                const ws2 = XLSX.utils.json_to_sheet(externalData);
                XLSX.utils.book_append_sheet(wb, ws2, `${monthName}å¤–å¸³`);
            }
            
            const businessName = business === 'studio' ? 'æ”å½±å·¥ä½œå®¤' : 'æ‰‹å·¥è—å“äº‹æ¥­';
            XLSX.writeFile(wb, `${businessName}${monthName}å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('æœˆå ±è¡¨Excelæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡º!');
        }

        // åˆ‡æ›äº¤æ˜“è¨˜éŒ„çš„å…¥å¸³ç‹€æ…‹
        function toggleTransactionStatus(business, category, id) {
            const transaction = businessData[business][category].find(t => t.id === id);
            if (!transaction) return;
            
            // åˆ‡æ›ç‹€æ…‹
            transaction.accountingStatus = transaction.accountingStatus === 'recorded' ? 'pending' : 'recorded';
            
            // å„²å­˜è³‡æ–™
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateView(business, currentView);
            if (currentView === 'dashboard') {
                updateDashboard(business);
            }
        }

        // æ›´æ–°å„€è¡¨æ¿
        function updateDashboard(business) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // è¨ˆç®—æœ¬æœˆçµ±è¨ˆ
            const monthlyInternal = businessData[business].internal
                .filter(t => {
                    const date = new Date(t.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                })
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyExternal = businessData[business].external
                .filter(t => {
                    const date = new Date(t.date);
                    return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                });
            
            const monthlyExternalIncome = monthlyExternal
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyExternalExpense = monthlyExternal
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyProfit = monthlyExternalIncome - monthlyExternalExpense - monthlyInternal;
            
            // è¨ˆç®—å¾…å…¥å¸³é‡‘é¡
            const pendingAmount = [
                ...businessData[business].internal.filter(t => t.accountingStatus === 'pending'),
                ...businessData[business].external.filter(t => t.accountingStatus === 'pending')
            ].reduce((sum, t) => sum + t.amount, 0);
            
            // æ›´æ–°é¡¯ç¤º
            const elements = {
                [`${business}-monthly-internal`]: `NT$ ${monthlyInternal.toLocaleString()}`,
                [`${business}-monthly-external-income`]: `NT$ ${monthlyExternalIncome.toLocaleString()}`,
                [`${business}-monthly-external-expense`]: `NT$ ${monthlyExternalExpense.toLocaleString()}`,
                [`${business}-monthly-profit`]: `NT$ ${monthlyProfit.toLocaleString()}`,
                [`${business}-pending-amount`]: `NT$ ${pendingAmount.toLocaleString()}`
            };
            
            Object.entries(elements).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                    if (id.includes('profit')) {
                        element.className = `stat-value ${monthlyProfit >= 0 ? 'amount-positive' : 'amount-negative'}`;
                    }
                }
            });
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const inventoryValue = businessData.craft.inventory.reduce((sum, item) => 
                    sum + (item.quantity * item.price), 0);
                
                const taiwanYouthValue = businessData.craft.inventory
                    .filter(item => item.brand === 'å°ç£é’å¹´')
                    .reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                const inventoryElement = document.getElementById('craft-inventory-value');
                const taiwanYouthElement = document.getElementById('craft-taiwan-youth-value');
                
                if (inventoryElement) inventoryElement.textContent = `NT$ ${inventoryValue.toLocaleString()}`;
                if (taiwanYouthElement) taiwanYouthElement.textContent = `NT$ ${taiwanYouthValue.toLocaleString()}`;
            }
            
            // æ›´æ–°æœ€è¿‘äº¤æ˜“
            updateRecentTransactions(business);
        }

        // æ›´æ–°æœ€è¿‘äº¤æ˜“è¨˜éŒ„
        function updateRecentTransactions(business) {
            const container = document.getElementById(business + '-recent-transactions');
            if (!container) return;
            
            // åˆä½µæ‰€æœ‰äº¤æ˜“è¨˜éŒ„
            const allTransactions = [
                ...businessData[business].internal.map(t => ({...t, category: 'internal'})),
                ...businessData[business].external.map(t => ({...t, category: 'external'}))
            ];
            
            const recentTransactions = allTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            container.innerHTML = recentTransactions.map(t => {
                let typeClass = '';
                let typeLabel = '';
                let amountPrefix = '';
                
                if (t.category === 'internal') {
                    typeClass = 'internal';
                    typeLabel = 'å…§å¸³';
                    amountPrefix = '-';
                } else if (t.type === 'income') {
                    typeClass = 'income';
                    typeLabel = 'å¤–å¸³æ”¶å…¥';
                    amountPrefix = '+';
                } else {
                    typeClass = 'expense';
                    typeLabel = 'å¤–å¸³æ”¯å‡º';
                    amountPrefix = '-';
                }
                
                const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : '';
                const invoiceInfo = t.invoiceNumber ? `<span class="invoice-number">${t.invoiceNumber}</span>` : '';
                const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', '${t.category}', ${t.id})" style="padding: 2px 6px; font-size: 10px; margin-left: 4px;">
                    ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                </button>`;
                
                return `
                    <div class="transaction-item ${typeClass}">
                        <div>
                            <div class="amount-display">${t.description}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">
                                <span class="tag tag-${typeClass}">${typeLabel}</span>
                                ${t.account} â€¢ ${t.date}
                                ${brandTag}
                                ${invoiceInfo}
                                ${statusTag}
                            </div>
                        </div>
                        <div class="amount-display ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amountPrefix}NT$ ${t.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å…§å¸³è¡¨æ ¼
        function updateInternalTable(business) {
            const tbody = document.getElementById(business + '-internal-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData[business].internal
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => {
                    const invoiceInfo = t.invoiceNumber ? 
                        `<div class="invoice-info">
                            <span class="invoice-number">${t.invoiceNumber}</span>
                            ${t.invoiceDate ? `<br><small>${t.invoiceDate}</small>` : ''}
                        </div>` : '-';
                    
                    const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', 'internal', ${t.id})" style="padding: 4px 8px; font-size: 11px;">
                        ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                    </button>`;
                    
                    return `
                        <tr>
                            <td>${t.date}</td>
                            <td><span class="tag tag-internal">${t.account}</span></td>
                            <td>${t.description}</td>
                            <td class="amount-display amount-negative">NT$ ${t.amount.toLocaleString()}</td>
                            <td>${invoiceInfo}</td>
                            <td>${statusTag}</td>
                            <td>
                                <button class="btn btn-coral" onclick="deleteTransaction('${business}', 'internal', ${t.id})" style="padding: 6px 12px; font-size: 12px;">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        // æ›´æ–°å¤–å¸³è¡¨æ ¼
        function updateExternalTable(business) {
            const tbody = document.getElementById(business + '-external-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData[business].external
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => {
                    const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : (t.brand || '-');
                    let brandColumn = '';
                    let productColumn = '';
                    
                    if (business === 'craft') {
                        brandColumn = `<td>${brandTag}</td>`;
                        
                        // å•†å“è³‡è¨Šæ¬„ä½
                        if (t.productInfo) {
                            const colorTag = t.productInfo.productColor ? `<span style="padding: 2px 4px; background: var(--macaron-sky); border-radius: 6px; font-size: 10px;">${t.productInfo.productColor}</span>` : '';
                            const sizeTag = t.productInfo.productSize ? `<span style="padding: 2px 4px; background: var(--macaron-peach); border-radius: 6px; font-size: 10px;">${t.productInfo.productSize}</span>` : '';
                            productColumn = `<td>
                                <div style="font-size: 12px;">
                                    <div style="font-weight: 600;">${t.productInfo.productName}</div>
                                    <div style="margin: 2px 0; color: var(--text-secondary);">${t.productInfo.productCategory}</div>
                                    <div style="display: flex; gap: 4px; align-items: center;">
                                        ${colorTag} ${sizeTag}
                                        <span style="font-size: 11px;">æ•¸é‡: ${t.productInfo.saleQuantity}</span>
                                    </div>
                                </div>
                            </td>`;
                        } else {
                            productColumn = '<td>-</td>';
                        }
                    }
                    
                    const invoiceInfo = t.invoiceNumber ? 
                        `<div class="invoice-info">
                            <span class="invoice-number">${t.invoiceNumber}</span>
                            ${t.invoiceDate ? `<br><small>${t.invoiceDate}</small>` : ''}
                        </div>` : '-';
                    
                    const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', 'external', ${t.id})" style="padding: 4px 8px; font-size: 11px;">
                        ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                    </button>`;
                    
                    return `
                        <tr>
                            <td>${t.date}</td>
                            <td><span class="tag tag-${t.type}">${t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span></td>
                            <td><span class="tag tag-${t.type}">${t.account}</span></td>
                            <td>${t.description}</td>
                            ${productColumn}
                            ${brandColumn}
                            <td class="amount-display ${t.type === 'income' ? 'amount-positive' : ''}">
                                ${t.type === 'income' ? `NT$ ${t.amount.toLocaleString()}` : '-'}
                            </td>
                            <td class="amount-display ${t.type === 'expense' ? 'amount-negative' : ''}">
                                ${t.type === 'expense' ? `NT$ ${t.amount.toLocaleString()}` : '-'}
                            </td>
                            <td>${invoiceInfo}</td>
                            <td>${statusTag}</td>
                            <td>
                                <button class="btn btn-coral" onclick="deleteTransaction('${business}', 'external', ${t.id})" style="padding: 6px 12px; font-size: 12px;">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        // æ›´æ–°åº«å­˜è¡¨æ ¼
        function updateInventoryTable() {
            const tbody = document.getElementById('craft-inventory-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData.craft.inventory.map(item => {
                const inventoryValue = item.cost * item.quantity;
                const brandTag = item.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : (item.brand || '-');
                const colorDisplay = item.color ? `<span style="padding: 2px 6px; background: var(--macaron-sky); border-radius: 8px; font-size: 11px;">${item.color}</span>` : '-';
                const sizeDisplay = item.size ? `<span style="padding: 2px 6px; background: var(--macaron-peach); border-radius: 8px; font-size: 11px;">${item.size}</span>` : '-';
                
                return `
                    <tr>
                        <td>${brandTag}</td>
                        <td>${item.category}</td>
                        <td>${item.name}</td>
                        <td>${colorDisplay}</td>
                        <td>${sizeDisplay}</td>
                        <td>NT$ ${item.cost.toLocaleString()}</td>
                        <td>NT$ ${item.price.toLocaleString()}</td>
                        <td>${item.quantity}</td>
                        <td>NT$ ${inventoryValue.toLocaleString()}</td>
                        <td>${item.notes || '-'}</td>
                        <td>
                            <button class="btn btn-coral" onclick="deleteInventory(${item.id})" style="padding: 6px 12px; font-size: 12px;">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°å¹´åº¦çµ±è¨ˆ
        function updateYearlyStats(business) {
            const currentYear = new Date().getFullYear();
            
            const yearlyExternal = businessData[business].external
                .filter(t => new Date(t.date).getFullYear() === currentYear);
            
            const yearlyExternalIncome = yearlyExternal
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const yearlyExternalExpense = yearlyExternal
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const yearlyInternalExpense = businessData[business].internal
                .filter(t => new Date(t.date).getFullYear() === currentYear)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const yearlyProfit = yearlyExternalIncome - yearlyExternalExpense - yearlyInternalExpense;
            const yearlyTotalIncome = yearlyExternalIncome;
            const yearlyTotalExpense = yearlyInternalExpense + yearlyExternalExpense;
            
            // è¨ˆç®—æ·¨åˆ©ç‡
            const profitMargin = yearlyTotalIncome > 0 ? ((yearlyProfit / yearlyTotalIncome) * 100).toFixed(1) : 0;
            
            // è¨ˆç®—å¹´åº¦å¾…å…¥å¸³é‡‘é¡
            const yearlyPending = [
                ...businessData[business].internal.filter(t => 
                    new Date(t.date).getFullYear() === currentYear && t.accountingStatus === 'pending'),
                ...businessData[business].external.filter(t => 
                    new Date(t.date).getFullYear() === currentYear && t.accountingStatus === 'pending')
            ].reduce((sum, t) => sum + t.amount, 0);
            
            // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
            const elements = {
                [`${business}-yearly-total-income`]: `NT$ ${yearlyTotalIncome.toLocaleString()}`,
                [`${business}-yearly-total-expense`]: `NT$ ${yearlyTotalExpense.toLocaleString()}`,
                [`${business}-yearly-income`]: `NT$ ${yearlyExternalIncome.toLocaleString()}`,
                [`${business}-yearly-expense`]: `NT$ ${yearlyExternalExpense.toLocaleString()}`,
                [`${business}-yearly-internal`]: `NT$ ${yearlyInternalExpense.toLocaleString()}`,
                [`${business}-yearly-profit`]: `NT$ ${yearlyProfit.toLocaleString()}`,
                [`${business}-yearly-pending`]: `NT$ ${yearlyPending.toLocaleString()}`,
                [`${business}-yearly-summary-income`]: `NT$ ${yearlyTotalIncome.toLocaleString()}`,
                [`${business}-yearly-summary-expense`]: `NT$ ${yearlyTotalExpense.toLocaleString()}`,
                [`${business}-yearly-summary-profit`]: `NT$ ${yearlyProfit.toLocaleString()}`,
                [`${business}-yearly-summary-margin`]: `${profitMargin}%`
            };
            
            Object.entries(elements).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                    if (id.includes('profit')) {
                        element.className = element.className.split(' ')[0] + (yearlyProfit >= 0 ? ' amount-positive' : ' amount-negative');
                    }
                }
            });
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const taiwanYouthSales = yearlyExternal
                    .filter(t => t.type === 'income' && t.brand === 'å°ç£é’å¹´')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const taiwanYouthRatio = yearlyTotalIncome > 0 ? ((taiwanYouthSales / yearlyTotalIncome) * 100).toFixed(1) : 0;
                
                const salesElement = document.getElementById('craft-taiwan-youth-sales');
                if (salesElement) salesElement.textContent = `NT$ ${taiwanYouthSales.toLocaleString()}`;
                
                const ratioElement = document.getElementById('craft-yearly-summary-taiwan-youth-ratio');
                if (ratioElement) ratioElement.textContent = `${taiwanYouthRatio}%`;
            }
            
            // ç¹ªè£½åœ–è¡¨
            drawYearlyCharts(business, currentYear);
        }

        // éŠ·æ¯€æ‰€æœ‰åœ–è¡¨
        function destroyAllCharts() {
            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};
        }

        // éŠ·æ¯€ç‰¹å®šæ¥­å‹™çš„åœ–è¡¨
        function destroyBusinessCharts(business) {
            Object.keys(chartInstances).forEach(key => {
                if (key.startsWith(business)) {
                    if (chartInstances[key]) {
                        chartInstances[key].destroy();
                        delete chartInstances[key];
                    }
                }
            });
        }

        // ç¹ªè£½å¹´åº¦åœ–è¡¨
        function drawYearlyCharts(business, year) {
            // å…ˆéŠ·æ¯€èˆŠåœ–è¡¨
            destroyBusinessCharts(business);
            
            // æº–å‚™æœˆåº¦æ•¸æ“š
            const monthlyData = prepareMonthlyData(business, year);
            
            // ç¹ªè£½æœˆåº¦è¶¨å‹¢åœ–
            drawMonthlyTrendChart(business, monthlyData);
            
            // ç¹ªè£½æ”¶æ”¯çµæ§‹åœ–
            drawExpensePieChart(business, monthlyData);
            
            // ç¹ªè£½æœˆåº¦æ·¨åˆ©åœ–
            drawProfitBarChart(business, monthlyData);
            
            // ç¹ªè£½æœƒè¨ˆç§‘ç›®åˆ†å¸ƒåœ–
            if (business === 'studio') {
                drawAccountChart(business, year);
            } else {
                // æ‰‹å·¥è—å“ç‰¹æœ‰åœ–è¡¨
                drawTaiwanYouthTrendChart(monthlyData);
                drawCategoryChart(year);
            }
        }

        // æº–å‚™æœˆåº¦æ•¸æ“š
        function prepareMonthlyData(business, year) {
            const monthlyData = [];
            
            for (let month = 0; month < 12; month++) {
                const monthTransactions = {
                    internal: businessData[business].internal.filter(t => {
                        const date = new Date(t.date);
                        return date.getFullYear() === year && date.getMonth() === month;
                    }),
                    external: businessData[business].external.filter(t => {
                        const date = new Date(t.date);
                        return date.getFullYear() === year && date.getMonth() === month;
                    })
                };
                
                const internalTotal = monthTransactions.internal.reduce((sum, t) => sum + t.amount, 0);
                const incomeTotal = monthTransactions.external.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenseTotal = monthTransactions.external.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const profit = incomeTotal - expenseTotal - internalTotal;
                
                // å°ç£é’å¹´éŠ·å”®(åƒ…æ‰‹å·¥è—å“)
                const taiwanYouthSales = monthTransactions.external
                    .filter(t => t.type === 'income' && t.brand === 'å°ç£é’å¹´')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                monthlyData.push({
                    month: month + 1,
                    monthName: `${month + 1}æœˆ`,
                    internal: internalTotal,
                    income: incomeTotal,
                    expense: expenseTotal,
                    profit: profit,
                    taiwanYouth: taiwanYouthSales
                });
            }
            
            return monthlyData;
        }

        // ç¹ªè£½æœˆåº¦è¶¨å‹¢åœ–
        function drawMonthlyTrendChart(business, monthlyData) {
            const ctx = document.getElementById(`${business}-monthly-trend-chart`);
            if (!ctx) return;
            
            chartInstances[`${business}-monthly-trend`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.monthName),
                    datasets: [
                        {
                            label: 'æ”¶å…¥',
                            data: monthlyData.map(d => d.income),
                            borderColor: '#059669',
                            backgroundColor: 'rgba(5, 150, 105, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'æ”¯å‡º',
                            data: monthlyData.map(d => d.internal + d.expense),
                            borderColor: '#DC2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': NT$ ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½æ”¶æ”¯çµæ§‹åœ–
        function drawExpensePieChart(business, monthlyData) {
            const ctx = document.getElementById(`${business}-expense-pie-chart`);
            if (!ctx) return;
            
            const totalInternal = monthlyData.reduce((sum, d) => sum + d.internal, 0);
            const totalExpense = monthlyData.reduce((sum, d) => sum + d.expense, 0);
            
            chartInstances[`${business}-expense-pie`] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å…§å¸³æ”¯å‡º', 'å¤–å¸³æ”¯å‡º'],
                    datasets: [{
                        data: [totalInternal, totalExpense],
                        backgroundColor: [
                            'rgba(213, 232, 255, 0.8)',
                            'rgba(255, 214, 232, 0.8)'
                        ],
                        borderColor: [
                            '#D5E8FF',
                            '#FFD6E8'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': NT$ ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½æœˆåº¦æ·¨åˆ©åœ–
        function drawProfitBarChart(business, monthlyData) {
            const ctx = document.getElementById(`${business}-profit-bar-chart`);
            if (!ctx) return;
            
            chartInstances[`${business}-profit-bar`] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(d => d.monthName),
                    datasets: [{
                        label: 'æœˆåº¦æ·¨åˆ©',
                        data: monthlyData.map(d => d.profit),
                        backgroundColor: monthlyData.map(d => d.profit >= 0 ? 'rgba(5, 150, 105, 0.6)' : 'rgba(220, 38, 38, 0.6)'),
                        borderColor: monthlyData.map(d => d.profit >= 0 ? '#059669' : '#DC2626'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'æ·¨åˆ©: NT$ ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½æœƒè¨ˆç§‘ç›®åˆ†å¸ƒåœ–(æ”å½±å·¥ä½œå®¤)
        function drawAccountChart(business, year) {
            const ctx = document.getElementById(`${business}-account-chart`);
            if (!ctx) return;
            
            // çµ±è¨ˆå„æœƒè¨ˆç§‘ç›®çš„æ”¯å‡º
            const accountStats = {};
            businessData[business].internal
                .filter(t => new Date(t.date).getFullYear() === year)
                .forEach(t => {
                    if (!accountStats[t.account]) {
                        accountStats[t.account] = 0;
                    }
                    accountStats[t.account] += t.amount;
                });
            
            const sortedAccounts = Object.entries(accountStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // åªé¡¯ç¤ºå‰8é …
            
            chartInstances[`${business}-account`] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedAccounts.map(a => a[0]),
                    datasets: [{
                        label: 'æ”¯å‡ºé‡‘é¡',
                        data: sortedAccounts.map(a => a[1]),
                        backgroundColor: 'rgba(232, 213, 255, 0.6)',
                        borderColor: '#E8D5FF',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'NT$ ' + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½å°ç£é’å¹´éŠ·å”®è¶¨å‹¢åœ–
        function drawTaiwanYouthTrendChart(monthlyData) {
            const ctx = document.getElementById('craft-taiwan-youth-trend-chart');
            if (!ctx) return;
            
            chartInstances['craft-taiwan-youth-trend'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.map(d => d.monthName),
                    datasets: [
                        {
                            label: 'å°ç£é’å¹´éŠ·å”®',
                            data: monthlyData.map(d => d.taiwanYouth),
                            borderColor: '#FF6B6B',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'ç¸½éŠ·å”®',
                            data: monthlyData.map(d => d.income),
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': NT$ ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½å•†å“é¡åˆ¥éŠ·å”®åˆ†å¸ƒåœ–
        function drawCategoryChart(year) {
            const ctx = document.getElementById('craft-category-chart');
            if (!ctx) return;
            
            // çµ±è¨ˆå„é¡åˆ¥çš„éŠ·å”®
            const categoryStats = {};
            businessData.craft.external
                .filter(t => t.type === 'income' && new Date(t.date).getFullYear() === year && t.productInfo)
                .forEach(t => {
                    const category = t.productInfo.productCategory;
                    if (!categoryStats[category]) {
                        categoryStats[category] = 0;
                    }
                    categoryStats[category] += t.amount;
                });
            
            const sortedCategories = Object.entries(categoryStats)
                .sort((a, b) => b[1] - a[1]);
            
            // ç”Ÿæˆæ¼¸å±¤è‰²å½©
            const colors = sortedCategories.map((_, i) => {
                const hue = (i * 360 / sortedCategories.length);
                return `hsla(${hue}, 70%, 75%, 0.7)`;
            });
            
            chartInstances['craft-category'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCategories.map(c => c[0]),
                    datasets: [{
                        label: 'éŠ·å”®é‡‘é¡',
                        data: sortedCategories.map(c => c[1]),
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace('0.7', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'NT$ ' + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ–°å¢äº¤æ˜“è¨˜éŒ„
        function addTransaction(business, category) {
            const prefix = business + '-' + category;
            const account = document.getElementById(prefix + '-account').value;
            const amount = parseFloat(document.getElementById(prefix + '-amount').value);
            const description = document.getElementById(prefix + '-description').value;
            const date = document.getElementById(prefix + '-date').value;
            const invoiceNumber = document.getElementById(prefix + '-invoice').value;
            const invoiceDate = document.getElementById(prefix + '-invoice-date').value;
            
            let type = null;
            let brand = '';
            let productInfo = null;
            
            if (category === 'external') {
                type = document.getElementById(prefix + '-type').value;
                if (business === 'craft') {
                    const brandElement = document.getElementById(prefix + '-brand');
                    if (brandElement) brand = brandElement.value;
                    
                    // è™•ç†å•†å“éŠ·å”®
                    if (type === 'income') {
                        const productId = document.getElementById('craft-external-product').value;
                        const saleQuantity = parseInt(document.getElementById('craft-external-sale-quantity').value);
                        
                        if (productId && saleQuantity) {
                            const product = businessData.craft.inventory.find(item => item.id == productId);
                            if (product) {
                                if (saleQuantity > product.quantity) {
                                    alert('éŠ·å”®æ•¸é‡ä¸èƒ½è¶…éåº«å­˜æ•¸é‡!');
                                    return;
                                }
                                
                                // æ‰£æ¸›åº«å­˜
                                product.quantity -= saleQuantity;
                                
                                // è¨˜éŒ„å•†å“è³‡è¨Š
                                productInfo = {
                                    productId: product.id,
                                    productName: product.name,
                                    productCategory: product.category,
                                    productColor: product.color,
                                    productSize: product.size,
                                    saleQuantity: saleQuantity,
                                    unitPrice: product.price
                                };
                            }
                        }
                    }
                }
            }
            
            if (!account || !amount || !description || !date) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                account,
                amount,
                description,
                date,
                invoiceNumber: invoiceNumber || '',
                invoiceDate: invoiceDate || '',
                accountingStatus: currentAccountingStatus[prefix],
                productInfo: productInfo
            };
            
            if (category === 'external') {
                newTransaction.type = type;
                if (business === 'craft') {
                    newTransaction.brand = brand;
                }
            }
            
            businessData[business][category].push(newTransaction);
            saveData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById(prefix + '-account').value = '';
            document.getElementById(prefix + '-amount').value = '';
            document.getElementById(prefix + '-description').value = '';
            document.getElementById(prefix + '-invoice').value = '';
            document.getElementById(prefix + '-invoice-date').value = '';
            
            if (category === 'external') {
                document.getElementById(prefix + '-type').value = 'income';
                if (business === 'craft') {
                    const brandElement = document.getElementById(prefix + '-brand');
                    if (brandElement) brandElement.value = '';
                    
                    // æ¸…ç©ºå•†å“é¸æ“‡
                    const productSelect = document.getElementById('craft-external-product');
                    const quantityInput = document.getElementById('craft-external-sale-quantity');
                    const infoDiv = document.getElementById('craft-selected-product-info');
                    if (productSelect) productSelect.value = '';
                    if (quantityInput) quantityInput.value = '';
                    if (infoDiv) infoDiv.innerHTML = '';
                    
                    // æ›´æ–°å•†å“é¸é …(å› ç‚ºåº«å­˜å¯èƒ½å·²æ”¹è®Š)
                    updateProductSelection();
                }
            }
            
            // é‡ç½®å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
            const toggleBtn = document.getElementById(prefix + '-status-toggle');
            const textSpan = document.getElementById(prefix + '-status-text');
            if (toggleBtn && textSpan) {
                toggleBtn.classList.remove('pending');
                textSpan.textContent = 'å·²å…¥å¸³';
                currentAccountingStatus[prefix] = 'recorded';
            }
            
            // éš±è—è¡¨å–®
            const formElement = document.getElementById(prefix + '-form');
            if (formElement) formElement.classList.add('hidden');
            
            // æ›´æ–°é¡¯ç¤º
            updateView(business, category);
            
            // å¦‚æœåœ¨å„€è¡¨æ¿,ä¹Ÿè¦æ›´æ–°å„€è¡¨æ¿
            if (currentView === 'dashboard') {
                updateDashboard(business);
            }
            
            // å¦‚æœæ˜¯å•†å“éŠ·å”®,ä¹Ÿæ›´æ–°åº«å­˜è¡¨æ ¼
            if (business === 'craft' && productInfo) {
                updateInventoryTable();
            }
            
            alert('äº¤æ˜“è¨˜éŒ„å·²æˆåŠŸæ–°å¢!');
        }

        // æ–°å¢åº«å­˜å•†å“
        function addInventoryItem() {
            const name = document.getElementById('inventory-name').value;
            const category = document.getElementById('inventory-category').value;
            const quantity = parseInt(document.getElementById('inventory-quantity').value);
            const cost = parseFloat(document.getElementById('inventory-cost').value);
            const price = parseFloat(document.getElementById('inventory-price').value);
            const brand = document.getElementById('inventory-brand').value;
            const color = document.getElementById('inventory-color').value;
            const size = document.getElementById('inventory-size').value;
            const notes = document.getElementById('inventory-notes').value;
            
            if (!name || !category || !quantity || !cost || !price) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            const newItem = {
                id: Date.now(),
                name,
                category,
                quantity,
                cost,
                price,
                brand,
                color,
                size,
                notes
            };
            
            businessData.craft.inventory.push(newItem);
            saveData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('inventory-name').value = '';
            document.getElementById('inventory-category').value = '';
            document.getElementById('inventory-quantity').value = '';
            document.getElementById('inventory-cost').value = '';
            document.getElementById('inventory-price').value = '';
            document.getElementById('inventory-brand').value = '';
            document.getElementById('inventory-color').value = '';
            document.getElementById('inventory-size').value = '';
            document.getElementById('inventory-notes').value = '';
            
            // éš±è—è¡¨å–®
            const formElement = document.getElementById('inventory-form');
            if (formElement) formElement.classList.add('hidden');
            
            // æ›´æ–°é¡¯ç¤º
            updateInventoryTable();
            updateProductSelection();
            if (currentView === 'dashboard') {
                updateDashboard('craft');
            }
            
            alert('å•†å“å·²æˆåŠŸæ–°å¢!');
        }

        // åˆªé™¤äº¤æ˜“è¨˜éŒ„
        function deleteTransaction(business, category, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—?')) return;
            
            // å¦‚æœæ˜¯æ‰‹å·¥è—å“çš„å•†å“éŠ·å”®,éœ€è¦æ¢å¾©åº«å­˜
            const transaction = businessData[business][category].find(t => t.id === id);
            if (transaction && transaction.productInfo && business === 'craft' && category === 'external') {
                const product = businessData.craft.inventory.find(item => item.id === transaction.productInfo.productId);
                if (product) {
                    product.quantity += transaction.productInfo.saleQuantity;
                }
            }
            
            businessData[business][category] = businessData[business][category].filter(t => t.id !== id);
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateView(business, category);
            if (currentView === 'dashboard') {
                updateDashboard(business);
            }
            
            // å¦‚æœæ˜¯å•†å“éŠ·å”®,ä¹Ÿæ›´æ–°åº«å­˜è¡¨æ ¼å’Œå•†å“é¸é …
            if (business === 'craft' && transaction && transaction.productInfo) {
                updateInventoryTable();
                updateProductSelection();
            }
            
            alert('è¨˜éŒ„å·²æˆåŠŸåˆªé™¤!');
        }

        // åˆªé™¤åº«å­˜å•†å“
        function deleteInventory(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—?')) return;
            
            businessData.craft.inventory = businessData.craft.inventory.filter(item => item.id !== id);
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateInventoryTable();
            updateProductSelection();
            if (currentView === 'dashboard') {
                updateDashboard('craft');
            }
            
            alert('å•†å“å·²æˆåŠŸåˆªé™¤!');
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) {
                if (confirm('æœ€å¾Œç¢ºèª:é€™å°‡åˆªé™¤æ‰€æœ‰äº¤æ˜“è¨˜éŒ„ã€åº«å­˜è³‡æ–™å’Œå®¢æˆ¶è¡¨å–®!')) {
                    localStorage.removeItem('businessData');
                    localStorage.removeItem('customerSubmissions');
                    
                    businessData = {
                        studio: {
                            internal: [],
                            external: []
                        },
                        craft: {
                            internal: [],
                            external: [],
                            inventory: []
                        }
                    };
                    
                    saveData();
                    
                    // éŠ·æ¯€æ‰€æœ‰åœ–è¡¨
                    destroyAllCharts();
                    
                    // æ›´æ–°å®¢æˆ¶è¡¨å–®æ•¸é‡
                    updateCustomerCount();
                    
                    // é‡æ–°è¼‰å…¥ç•¶å‰è¦–åœ–
                    if (currentBusiness && currentView) {
                        updateView(currentBusiness, currentView);
                    }
                    
                    alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤!');
                }
            }
        }

        // åŒ¯å‡ºExcelåŠŸèƒ½
        function exportToExcel(business) {
            if (typeof XLSX === 'undefined') {
                alert('ExcelåŠŸèƒ½è¼‰å…¥ä¸­,è«‹ç¨å¾Œå†è©¦...');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // å…§å¸³å ±è¡¨
            const internalData = businessData[business].internal.map(t => ({
                'äº¤æ˜“æ—¥æœŸ': t.date,
                'æœƒè¨ˆç§‘ç›®': t.account,
                'æ‘˜è¦èªªæ˜': t.description,
                'é‡‘é¡': t.amount,
                'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
            }));
            
            const ws1 = XLSX.utils.json_to_sheet(internalData);
            XLSX.utils.book_append_sheet(wb, ws1, 'å…§å¸³è¨˜éŒ„');
            
            // å¤–å¸³å ±è¡¨
            const externalData = businessData[business].external.map(t => {
                const data = {
                    'äº¤æ˜“æ—¥æœŸ': t.date,
                    'æœƒè¨ˆç§‘ç›®': t.account,
                    'æ‘˜è¦èªªæ˜': t.description,
                    'æ”¶å…¥': t.type === 'income' ? t.amount : '',
                    'æ”¯å‡º': t.type === 'expense' ? t.amount : '',
                    'é¡å‹': t.type === 'income' ? 'ç‡Ÿæ¥­æ”¶å…¥' : 'ç‡Ÿæ¥­æ”¯å‡º',
                    'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                    'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                    'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                };
                
                if (business === 'craft') {
                    data['å“ç‰Œ'] = t.brand || '';
                    if (t.productInfo) {
                        data['å•†å“åç¨±'] = t.productInfo.productName;
                        data['å•†å“é¡åˆ¥'] = t.productInfo.productCategory;
                        data['é¡è‰²'] = t.productInfo.productColor || '';
                        data['å°ºå¯¸'] = t.productInfo.productSize || '';
                        data['éŠ·å”®æ•¸é‡'] = t.productInfo.saleQuantity;
                    }
                }
                
                return data;
            });
            
            const ws2 = XLSX.utils.json_to_sheet(externalData);
            XLSX.utils.book_append_sheet(wb, ws2, 'å¤–å¸³è¨˜éŒ„');
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰:åº«å­˜å ±è¡¨
            if (business === 'craft') {
                const inventoryData = businessData.craft.inventory.map(item => ({
                    'å•†å“åç¨±': item.name,
                    'å•†å“åˆ†é¡': item.category,
                    'é¡è‰²': item.color || '',
                    'å°ºå¯¸': item.size || '',
                    'å“ç‰Œ': item.brand || '',
                    'åº«å­˜æ•¸é‡': item.quantity,
                    'å–®ä½æˆæœ¬': item.cost,
                    'å–®ä½å”®åƒ¹': item.price,
                    'ç¸½æˆæœ¬': item.quantity * item.cost,
                    'ç¸½åƒ¹å€¼': item.quantity * item.price,
                    'æ¯›åˆ©ç‡': `${((item.price - item.cost) / item.price * 100).toFixed(1)}%`,
                    'å‚™è¨»': item.notes || ''
                }));
                
                const ws3 = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, ws3, 'åº«å­˜å ±è¡¨');
            }
            
            const businessName = business === 'studio' ? 'æ”å½±å·¥ä½œå®¤' : 'æ‰‹å·¥è—å“äº‹æ¥­';
            XLSX.writeFile(wb, `${businessName}å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('Excelæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡º!');
        }

        // æ›´æ–°å®¢æˆ¶è¡¨å–®æ•¸é‡
        function updateCustomerCount() {
            const submissions = JSON.parse(localStorage.getItem('customerSubmissions') || '[]');
            const countElement = document.getElementById('customer-count');
            if (countElement) {
                countElement.textContent = submissions.length;
                if (submissions.length === 0) {
                    countElement.classList.add('zero');
                } else {
                    countElement.classList.remove('zero');
                }
            }
        }

        // é¡¯ç¤ºå®¢æˆ¶è¡¨å–®
        function showCustomerSubmissions() {
            const submissions = JSON.parse(localStorage.getItem('customerSubmissions') || '[]');
            const customerList = document.getElementById('customer-list');
            
            // éš±è—å…¶ä»–å€åŸŸ
            document.getElementById('studio-section').classList.add('hidden');
            document.getElementById('craft-section').classList.add('hidden');
            document.getElementById('customer-section').classList.remove('hidden');
            
            if (submissions.length === 0) {
                customerList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">ç›®å‰æ²’æœ‰å®¢æˆ¶è¡¨å–®</p>';
                return;
            }
            
            customerList.innerHTML = submissions.map((submission, index) => {
                const submitDate = new Date(submission.submittedAt).toLocaleString('zh-TW');
                
                if (submission.type === 'studio-booking') {
                    // æ”å½±æœå‹™é ç´„
                    return `
                        <div class="pending-card">
                            <div class="pending-header">
                                <div class="pending-info">
                                    <div class="pending-title">ğŸ“¸ æ”å½±æœå‹™é ç´„</div>
                                    <div class="pending-meta">
                                        æäº¤æ™‚é–“: ${submitDate}
                                    </div>
                                </div>
                                <div class="pending-actions">
                                    <button class="btn btn-success btn-small" onclick="convertToTransaction(${index}, 'studio')">
                                        ğŸ’° è½‰ç‚ºäº¤æ˜“è¨˜éŒ„
                                    </button>
                                    <button class="btn btn-coral btn-small" onclick="deleteCustomerSubmission(${index})">
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            </div>
                            <div class="pending-detail">
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">å®¢æˆ¶å§“å:</span>
                                    <span class="pending-detail-value">${submission.name}</span>
                                </div>
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">è¯çµ¡é›»è©±:</span>
                                    <span class="pending-detail-value">${submission.phone}</span>
                                </div>
                                ${submission.email ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">Email:</span>
                                    <span class="pending-detail-value">${submission.email}</span>
                                </div>
                                ` : ''}
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">æœå‹™é …ç›®:</span>
                                    <span class="pending-detail-value">${submission.service}</span>
                                </div>
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">é è¨ˆæ—¥æœŸ:</span>
                                    <span class="pending-detail-value">${submission.date}</span>
                                </div>
                                ${submission.budget ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">é ç®—ç¯„åœ:</span>
                                    <span class="pending-detail-value">${submission.budget}</span>
                                </div>
                                ` : ''}
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">éœ€æ±‚èªªæ˜:</span>
                                    <span class="pending-detail-value">${submission.note}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // æ‰‹å·¥è—å“è¨‚å–®
                    return `
                        <div class="pending-card">
                            <div class="pending-header">
                                <div class="pending-info">
                                    <div class="pending-title">ğŸ¨ æ‰‹å·¥è—å“è¨‚å–®</div>
                                    <div class="pending-meta">
                                        æäº¤æ™‚é–“: ${submitDate}
                                    </div>
                                </div>
                                <div class="pending-actions">
                                    <button class="btn btn-success btn-small" onclick="convertToTransaction(${index}, 'craft')">
                                        ğŸ’° è½‰ç‚ºäº¤æ˜“è¨˜éŒ„
                                    </button>
                                    <button class="btn btn-coral btn-small" onclick="deleteCustomerSubmission(${index})">
                                        ğŸ—‘ï¸ åˆªé™¤
                                    </button>
                                </div>
                            </div>
                            <div class="pending-detail">
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">å®¢æˆ¶å§“å:</span>
                                    <span class="pending-detail-value">${submission.name}</span>
                                </div>
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">è¯çµ¡é›»è©±:</span>
                                    <span class="pending-detail-value">${submission.phone}</span>
                                </div>
                                ${submission.email ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">Email:</span>
                                    <span class="pending-detail-value">${submission.email}</span>
                                </div>
                                ` : ''}
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">å•†å“é¡åˆ¥:</span>
                                    <span class="pending-detail-value">${submission.category}</span>
                                </div>
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">å•†å“åç¨±:</span>
                                    <span class="pending-detail-value">${submission.product}</span>
                                </div>
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">æ•¸é‡:</span>
                                    <span class="pending-detail-value">${submission.quantity} ä»¶</span>
                                </div>
                                ${submission.spec ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">é¡è‰²/å°ºå¯¸:</span>
                                    <span class="pending-detail-value">${submission.spec}</span>
                                </div>
                                ` : ''}
                                ${submission.address ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">æ”¶ä»¶åœ°å€:</span>
                                    <span class="pending-detail-value">${submission.address}</span>
                                </div>
                                ` : ''}
                                ${submission.note ? `
                                <div class="pending-detail-row">
                                    <span class="pending-detail-label">å‚™è¨»:</span>
                                    <span class="pending-detail-value">${submission.note}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // è½‰ç‚ºäº¤æ˜“è¨˜éŒ„
        function convertToTransaction(index, business) {
            const submissions = JSON.parse(localStorage.getItem('customerSubmissions') || '[]');
            const submission = submissions[index];
            
            // è©¢å•é‡‘é¡
            const amount = prompt('è«‹è¼¸å…¥é€™ç­†äº¤æ˜“çš„é‡‘é¡ (NT$):');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                return;
            }
            
            let account, description;
            
            if (submission.type === 'studio-booking') {
                // æ”å½±æœå‹™ - æ”¶å…¥
                const accountChoice = prompt('è«‹é¸æ“‡æœƒè¨ˆç§‘ç›®:\n1. æ”å½±æœå‹™æ”¶å…¥\n2. å©šç¦®æ”å½±æ”¶å…¥\n3. å•†æ¥­æ”å½±æ”¶å…¥\n4. äººåƒæ”å½±æ”¶å…¥\n5. æ´»å‹•æ”å½±æ”¶å…¥\n6. å½±ç‰‡è£½ä½œæ”¶å…¥\n7. å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥\n\nè«‹è¼¸å…¥æ•¸å­— (1-7):', '1');
                
                const accountMap = {
                    '1': 'æ”å½±æœå‹™æ”¶å…¥',
                    '2': 'å©šç¦®æ”å½±æ”¶å…¥',
                    '3': 'å•†æ¥­æ”å½±æ”¶å…¥',
                    '4': 'äººåƒæ”å½±æ”¶å…¥',
                    '5': 'æ´»å‹•æ”å½±æ”¶å…¥',
                    '6': 'å½±ç‰‡è£½ä½œæ”¶å…¥',
                    '7': 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                };
                
                account = accountMap[accountChoice] || 'æ”å½±æœå‹™æ”¶å…¥';
                description = `${submission.service} - ${submission.name} (${submission.phone})`;
                
                // åŠ å…¥äº¤æ˜“è¨˜éŒ„
                const newTransaction = {
                    id: Date.now(),
                    type: 'income',
                    account: account,
                    amount: parseFloat(amount),
                    description: description,
                    date: submission.date,
                    invoiceNumber: '',
                    invoiceDate: '',
                    accountingStatus: 'recorded'
                };
                
                businessData.studio.external.push(newTransaction);
                
            } else {
                // æ‰‹å·¥è—å“ - æ”¶å…¥
                const categoryMap = {
                    'ä¸Šè¡£': 'ä¸Šè¡£éŠ·å”®æ”¶å…¥',
                    'ä¸‹è‘—': 'ä¸‹è‘—éŠ·å”®æ”¶å…¥',
                    'å¤–å¥—': 'å¤–å¥—éŠ·å”®æ”¶å…¥',
                    'é€£èº«è£™': 'é€£èº«è£™éŠ·å”®æ”¶å…¥',
                    'é…ä»¶': 'é…ä»¶éŠ·å”®æ”¶å…¥',
                    'é£¾å“': 'é£¾å“éŠ·å”®æ”¶å…¥',
                    'åŒ…åŒ…': 'åŒ…åŒ…éŠ·å”®æ”¶å…¥',
                    'å®¶å±…ç”¨å“': 'å®¶å±…ç”¨å“éŠ·å”®æ”¶å…¥',
                    'æ–‡å…·ç”¨å“': 'æ–‡å…·ç”¨å“éŠ·å”®æ”¶å…¥',
                    'å…¶ä»–': 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                };
                
                account = categoryMap[submission.category] || 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥';
                description = `${submission.product} x ${submission.quantity} - ${submission.name} (${submission.phone})`;
                
                // åŠ å…¥äº¤æ˜“è¨˜éŒ„
                const newTransaction = {
                    id: Date.now(),
                    type: 'income',
                    account: account,
                    amount: parseFloat(amount),
                    description: description,
                    date: new Date().toISOString().split('T')[0],
                    brand: '',
                    invoiceNumber: '',
                    invoiceDate: '',
                    accountingStatus: 'recorded'
                };
                
                businessData.craft.external.push(newTransaction);
            }
            
            saveData();
            
            // å¾å®¢æˆ¶è¡¨å–®ä¸­ç§»é™¤
            submissions.splice(index, 1);
            localStorage.setItem('customerSubmissions', JSON.stringify(submissions));
            
            // æ›´æ–°é¡¯ç¤º
            updateCustomerCount();
            showCustomerSubmissions();
            
            alert('âœ… å·²æˆåŠŸè½‰ç‚ºäº¤æ˜“è¨˜éŒ„!');
        }

        // åˆªé™¤å®¢æˆ¶è¡¨å–®
        function deleteCustomerSubmission(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å®¢æˆ¶è¡¨å–®å—?')) return;
            
            const submissions = JSON.parse(localStorage.getItem('customerSubmissions') || '[]');
            submissions.splice(index, 1);
            localStorage.setItem('customerSubmissions', JSON.stringify(submissions));
            
            // æ›´æ–°é¡¯ç¤º
            updateCustomerCount();
            showCustomerSubmissions();
            
            alert('å·²åˆªé™¤å®¢æˆ¶è¡¨å–®!');
        }

        // é—œé–‰å®¢æˆ¶è¡¨å–®
        function closeCustomerSubmissions() {
            document.getElementById('customer-section').classList.add('hidden');
            switchBusiness(currentBusiness || 'studio');
        }
    </script>
</body>
</html>